*&---------------------------------------------------------------------*
*& Report ZEF_EXTRATOR_DM
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT zef_extrator_dm.

INCLUDE zef_extrator_dm_TOP.
TABLES: t004, "-> tabela de consulta do plano de contas
        t001, "-> Tabela de consulta de empresas
        t880, "-> Tabela de consulta de Sociedade parceira
        tgsb, "-> Tabela de divisao
        t001k,"-> Tabela de centro de distribuicao
        t001w,"-> Tabela de auxilio para avaliacao do centro de distribuicao
        ska1, "-> Tabela de consulta para data de criacao
        skb1, "-> Tabela de consulta para data de ultima modificacao
        t004f,"-> Tabela de definicao de status do grupo
        cdhdr,
        csks,
        cskt,
        cepc,
        cepc_bukrs,
        cepct,
        cmdt_pc,
        coas,
        TJ02T,
        TJ30T.


TYPES: BEGIN OF ty_parametros, " Tipo de parametros
         valor TYPE j_1bbranch-branch, " https://www.se80.co.uk/sap-function-modules/?name=j_1b_branch_read
       END OF ty_parametros.

DATA: it_parametros TYPE TABLE OF ty_parametros, " Tabela interna de parametros
      wa_parametros TYPE ty_parametros. " Work area de parametros

wa_parametros-valor = '7000'.
APPEND wa_parametros TO it_parametros.
wa_parametros-valor = '7020'.
APPEND wa_parametros TO it_parametros.
wa_parametros-valor = '7060'.
APPEND wa_parametros TO it_parametros.

TYPES: BEGIN OF ty_parametros_invest, " Tipo de parametros para consulta de investimentos
         valor TYPE aufnr,
       END OF ty_parametros_invest.


DATA: it_parametros_invest TYPE TABLE OF ty_parametros_invest, " Tabela interna de parametros
      wa_parametros_invest TYPE ty_parametros_invest. " Work area de parametros
DATA: it_parametros_invest_MD TYPE TABLE OF ty_parametros_invest, " Tabela interna de parametros
      wa_parametros_invest_MD TYPE ty_parametros_invest. " Work area de parametros

wa_parametros_invest-valor = '01'.
APPEND wa_parametros_invest TO it_parametros_invest.
wa_parametros_invest-valor = '02'.
APPEND wa_parametros_invest TO it_parametros_invest.
wa_parametros_invest-valor = '03'.
APPEND wa_parametros_invest TO it_parametros_invest.

DATA: branch_value TYPE n.

DATA: it_t001 TYPE STANDARD TABLE OF t001,
      wa_t001 TYPE t001.

DATA: it_t880 TYPE STANDARD TABLE OF t880,
      wa_t880 TYPE t880.

DATA: it_tgsb TYPE STANDARD TABLE OF tgsb,
      wa_tgsb TYPE tgsb.

DATA: it_t001w TYPE STANDARD TABLE OF t001w,
      wa_t001w TYPE t001w.

DATA: emp_cnpj    TYPE j_1bcgc,
      wa_insc_est TYPE j_1bbranch.

DATA: wa_endereco_v TYPE addr1_val.
DATA: wa_cidade_est TYPE sadr.

DATA: it_ska1 TYPE STANDARD TABLE OF ska1,
      wa_ska1 TYPE ska1.
DATA: it_skb1 TYPE  STANDARD TABLE OF skb1,
      wa_skb1 TYPE skb1.

DATA: wa_faus1 TYPE faus1.

DATA: lv_text TYPE string.

DATA: lv_filename TYPE string.
DATA: lt_conteudo TYPE TABLE OF string,
      lv_line     TYPE string,
      lv_line2    TYPE string,
      lv_line3    TYPE string,
      lv_datetime TYPE string.

lv_datetime = |{ sy-datum }_{ sy-uzeit }|.

DATA: it_cdhdr TYPE STANDARD TABLE OF cdhdr,
      wa_cdhdr TYPE cdhdr.

CONSTANTS obj_conta TYPE string VALUE 'SACH'.

DATA: it_csks TYPE STANDARD TABLE OF csks,
      wa_csks TYPE csks,
      it_cskt TYPE STANDARD TABLE OF cskt,
      wa_cskt TYPE cskt.

CONSTANTS obj_ccusto TYPE string VALUE 'KOSTL'.

DATA: it_cepc TYPE STANDARD TABLE OF cepc,
      wa_cepc TYPE cepc.

DATA: it_cepct TYPE STANDARD TABLE OF cepct,
      wa_cepct TYPE cepct.

DATA: it_cepc_bukrs TYPE STANDARD TABLE OF cepc_bukrs,
      wa_cepc_bukrs TYPE cepc_bukrs.

CONSTANTS obj_clucro TYPE string VALUE 'PRCTR'.

DATA: it_cmdt_pc TYPE STANDARD TABLE OF cmdt_pc,
      wa_cmdt_pc TYPE cmdt_pc.

DATA: it_coas TYPE TABLE OF coas,
      wa_coas TYPE coas.

CONSTANTS cat_order TYPE string VALUE ''.

DATA: it_cat_order TYPE TABLE OF ty_parametros, " Tabela interna de parametros
      wa_cat_order TYPE ty_parametros. " Work area de parametros

DATA lv_return TYPE bapireturn.

DATA: lt_system_status     TYPE STANDARD TABLE OF TJ02T,
      wa_system_status     TYPE TJ02T,
      lt_user_status       TYPE STANDARD TABLE OF TJ30T,
      wa_user_status       TYPE TJ30T,
      lt_allowed_bus_tract TYPE STANDARD TABLE OF bapi2075_5,
      wa_allowed_status    TYPE bapi2075_5.

**********************************


INCLUDE zef_extrator_dm_SEL.
*&---------------------------------------------------------------------*
*& Include          ZEF_EXTRATOR_DM_SEL
*&---------------------------------------------------------------------*

SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE TEXT-001.
  SELECTION-SCREEN BEGIN OF LINE.
    PARAMETERS:
    box_emp AS CHECKBOX DEFAULT ' '. " Default define como nao marcado o checkbox
    SELECTION-SCREEN COMMENT 4(20) TEXT-002.
  SELECTION-SCREEN END OF LINE.

  SELECTION-SCREEN BEGIN OF LINE.
    PARAMETERS:
    box_sp AS CHECKBOX DEFAULT ' '. " Sociedade Parceira
    SELECTION-SCREEN COMMENT 4(30) TEXT-003.
  SELECTION-SCREEN END OF LINE.

  SELECTION-SCREEN BEGIN OF LINE.
    PARAMETERS:
    box_div AS CHECKBOX DEFAULT ' '. " Divisao
    SELECTION-SCREEN COMMENT 4(20) TEXT-004.
  SELECTION-SCREEN END OF LINE.

  SELECTION-SCREEN BEGIN OF LINE.
    PARAMETERS:
     box_cen AS CHECKBOX DEFAULT ' '. " Centro
    SELECTION-SCREEN COMMENT 4(20) TEXT-005.
  SELECTION-SCREEN END OF LINE.

************************************************************************

  SELECTION-SCREEN BEGIN OF LINE.
    PARAMETERS: box_cnt AS CHECKBOX DEFAULT ' '. " Contas
    SELECTION-SCREEN COMMENT 4(20) TEXT-006.
    SELECTION-SCREEN COMMENT (15) TEXT-012.
    PARAMETERS pl_de_c TYPE t004-ktopl.
  SELECTION-SCREEN END OF LINE.

************************************************************************

  SELECTION-SCREEN BEGIN OF LINE.
    PARAMETERS:
     box_cdc AS CHECKBOX DEFAULT ' '. " Centro de custo
    SELECTION-SCREEN COMMENT 4(25) TEXT-007.
  SELECTION-SCREEN END OF LINE.

  SELECTION-SCREEN BEGIN OF LINE.
    PARAMETERS:
      box_cdl AS CHECKBOX DEFAULT ' '. " Centro de lucro
    SELECTION-SCREEN COMMENT 4(25) TEXT-008.
  SELECTION-SCREEN END OF LINE.

  SELECTION-SCREEN BEGIN OF LINE.
    PARAMETERS:
     box_odi AS CHECKBOX DEFAULT ' '. " Ordem de investimento
    SELECTION-SCREEN COMMENT 4(45) TEXT-009.
  SELECTION-SCREEN END OF LINE.

  SELECTION-SCREEN BEGIN OF LINE.
    PARAMETERS:
     box_epep AS CHECKBOX DEFAULT ' '. " Elemento PEP
    SELECTION-SCREEN COMMENT 4(22) TEXT-010.
  SELECTION-SCREEN END OF LINE.

  SELECTION-SCREEN BEGIN OF LINE.
    PARAMETERS:
    box_ntw AS CHECKBOX DEFAULT ' '. " Network
    SELECTION-SCREEN COMMENT 4(17) TEXT-011.
  SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN END OF BLOCK b1.

************************************************************************
ULINE.
SELECTION-SCREEN BEGIN OF BLOCK b2 WITH FRAME.
  SELECTION-SCREEN BEGIN OF LINE.
    SELECTION-SCREEN COMMENT (25) TEXT-014.
    PARAMETERS: p_dt_i TYPE sy-datum . "Data de criacao Inicio
    SELECTION-SCREEN POSITION 40.
    SELECTION-SCREEN COMMENT (5) TEXT-013.
    PARAMETERS: p_dt_f TYPE sy-datum . "Data de criacao Final
  SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN END OF BLOCK b2.

************************************************************************
ULINE.
SELECTION-SCREEN BEGIN OF BLOCK b3 WITH FRAME TITLE TEXT-015.
  SELECTION-SCREEN BEGIN OF LINE.
    PARAMETERS: bt_local RADIOBUTTON GROUP rg1.
    SELECTION-SCREEN COMMENT (25) TEXT-017.
  SELECTION-SCREEN END OF LINE.
  SELECTION-SCREEN BEGIN OF LINE.
    PARAMETERS: bt_serv RADIOBUTTON GROUP rg1.
    SELECTION-SCREEN COMMENT (25) TEXT-016.
  SELECTION-SCREEN END OF LINE.
    SELECTION-SCREEN BEGIN OF LINE.
    SELECTION-SCREEN COMMENT (30) TEXT-018.
    PARAMETERS: p_save TYPE string.
  SELECTION-SCREEN END OF LINE.


SELECTION-SCREEN END OF BLOCK b3.


**********************************



INCLUDE zef_extrator_dm_F01.

**********************************

IF box_emp EQ 'X'. " Campo empresa
  CLEAR lt_conteudo. " Limpando tabela interna para evitar duplicidade caso salve mais de um arquivo ao mesmo tempo
  CONCATENATE p_save '\INFINITFY_EMPRESA_' lv_datetime '.txt' INTO lv_filename. " Concatenando o caminho de entrada pela aplicacao, nome padrao, data e hora atual  e formato
  SELECT * INTO TABLE it_t001 FROM t001.
  LOOP AT it_t001 INTO wa_t001.
    PERFORM buscar_cpnj USING wa_t001-bukrs CHANGING emp_cnpj.
    PERFORM buscar_endereco.
    CONCATENATE 'Empresa' wa_t001-bukrs
              ' | Nome' wa_t001-butxt
              ' | CNPJ' emp_cnpj
              ' | País' wa_t001-land1
              ' | Rua ' wa_endereco_v-street
              ', Número' wa_endereco_v-house_num1
              ' - Distrito' wa_endereco_v-city2
              'Cidade/Estado' wa_cidade_est-ort01
              '/' wa_cidade_est-regio
              'CEP'  wa_endereco_v-post_code1
              ' | Moeda Padrão' wa_t001-waers
              INTO lv_line SEPARATED BY space.
    APPEND lv_line TO lt_conteudo. " Preenchendo a tabela interna com o conteudo
  ENDLOOP.
  PERFORM salvar_em_texto. " Funcao para fazer download da tabela interna preenchida
ENDIF.

**********************************

IF box_sp EQ 'X'. " Campo sociedade parceira
  CLEAR lt_conteudo.
  CONCATENATE p_save '\INFINITFY_SOCIEDADEPARCEIRA_' lv_datetime '.txt' INTO lv_filename.
  SELECT * INTO TABLE it_t880 FROM t880.
  LOOP AT it_t880 INTO wa_t880.
    CONCATENATE 'Sociedade' wa_t880-rcomp
             ' | Nome' wa_t880-name1
             ' | Raiz' wa_t880-name2
             ' | País' wa_t880-cntry
             ' | Moeda' wa_t880-curr
             ' | Rua' wa_t880-stret
             ' | CEP' wa_t880-pstlc
             ' | Cidade' wa_t880-city
             INTO lv_line SEPARATED BY space.
    APPEND lv_line TO lt_conteudo.
  ENDLOOP.
  PERFORM salvar_em_texto.
ENDIF.

**********************************

IF box_div EQ 'X'. " Campo divisao
  CLEAR lt_conteudo.
  CONCATENATE p_save '\INFINITFY_DIVISAO_' lv_datetime '.txt' INTO lv_filename.
  SELECT * INTO TABLE it_tgsb FROM tgsb.
  LOOP AT it_tgsb INTO wa_tgsb.
    CONCATENATE  'Divisão' wa_tgsb-gsber
                 ' | Descrição' wa_tgsb-gsber_glob
                 INTO lv_line SEPARATED BY space.
    APPEND lv_line TO lt_conteudo.
  ENDLOOP.
  PERFORM salvar_em_texto.
ENDIF.

IF box_cen EQ 'X'. " Campo centro
  CLEAR lt_conteudo.
  CONCATENATE p_save '\INFINITFY_CENTRO_' lv_datetime '.txt' INTO lv_filename.
  SELECT * INTO TABLE it_t001w FROM t001w.
  LOOP AT it_t001w INTO wa_t001w.
    CONCATENATE 'Centro' wa_t001w-werks
             ' | Nome' wa_t001w-name1
             INTO lv_line SEPARATED BY space.
    APPEND lv_line TO lt_conteudo.
  ENDLOOP.
  PERFORM salvar_em_texto.
ENDIF.

**********************************

IF box_cnt EQ 'X'. " Campo contas
  CLEAR lt_conteudo.
  CONCATENATE p_save '\INFINITFY_CONTAS_' lv_datetime '.txt' INTO lv_filename.

  IF pl_de_c IS INITIAL.
    MESSAGE 'Erro: O campo Plano de Contas é obrigatório.' TYPE 'E'.
  ENDIF.

  SELECT * INTO TABLE it_ska1 FROM ska1 WHERE erdat >= p_dt_i.
  LOOP AT it_ska1 INTO wa_ska1.

    LOOP AT it_skb1 INTO wa_skb1 WHERE saknr = wa_ska1-saknr AND erdat <= p_dt_f.
      SELECT SINGLE bukrs xspeb INTO wa_skb1 FROM skb1 WHERE saknr = wa_ska1-saknr AND bukrs = wa_skb1-bukrs.

      CONCATENATE ' | Empresa' wa_skb1-bukrs
       'Conta' wa_ska1-saknr
      ' | Plano_Contas' wa_ska1-ktopl
*      WRITE: ' | Descrição', wa_ska1-txt20. Aparentemente nao existe este campo
      ' | Balanço' wa_ska1-xbilk
      INTO lv_line SEPARATED BY space.

      SELECT SINGLE faus1 INTO wa_faus1 FROM t004f WHERE fstag = wa_SKB1-fstag. "Select para centro
      IF wa_faus1+25(1) = '+'.
        CONCATENATE ' | Centro' 'X' INTO lv_line.
      ENDIF.
      IF wa_faus1+8(1) = '+'.
        CONCATENATE ' | Material' 'X' INTO lv_line.
      ENDIF.
      IF wa_faus1+9(1) = '+'.
        CONCATENATE ' | CCusto' 'X' INTO lv_line.
      ENDIF.
      IF wa_faus1+10(1) = '+'.
        CONCATENATE ' | Ordem' 'X' INTO lv_line.
      ENDIF.
      IF wa_faus1+11(1) = '+'.
        CONCATENATE ' | PEP' 'X' INTO lv_line.
      ENDIF.
      IF wa_faus1+18(1) = '+'.
        CONCATENATE ' | Network' 'X' INTO lv_line.
      ENDIF.
      CONCATENATE ' | Bl_Lan_Plano' wa_ska1-xspeb INTO lv_line.

      SELECT SINGLE bukrs xspeb INTO wa_skb1 FROM skb1 WHERE saknr = wa_ska1-saknr AND bukrs = wa_skb1-bukrs.
      CONCATENATE ' | Empresa' wa_skb1-bukrs
       ' | Bl_Lan_Empresa' wa_skb1-xspeb
       INTO lv_line.
      APPEND lv_line TO lt_conteudo.
    ENDLOOP.
    PERFORM salvar_em_texto.
  ENDLOOP.

****************** Contas modificadas
  CLEAR lt_conteudo.
  SELECT * FROM cdhdr INTO TABLE it_cdhdr WHERE objectclas = 'OBJ_CONTA' AND udate BETWEEN p_dt_i AND p_dt_f.
  DATA: lv_ktopl TYPE TABLE OF ska1-saknr.
  LOOP AT it_cdhdr INTO wa_cdhdr.
    READ TABLE it_ska1 INTO wa_ska1 WITH KEY ktopl = pl_de_c.
    READ TABLE it_skb1 INTO wa_skb1 WITH KEY saknr = wa_ska1-saknr.
    DATA(lv_obj1) = |{ wa_ska1-ktopl }{ wa_ska1-saknr }| .
    DATA(lv_obj2) = |{ wa_ska1-ktopl }{ wa_skb1-saknr }| .

    CONCATENATE ' | Empresa' wa_skb1-bukrs
   'Conta' wa_ska1-saknr
  ' | Plano_Contas' wa_ska1-ktopl
*      WRITE: ' | Descrição', wa_ska1-txt20. Aparentemente nao existe este campo
  ' | Balanço' wa_ska1-xbilk
  INTO lv_line SEPARATED BY space.

    SELECT SINGLE faus1 INTO wa_faus1 FROM t004f WHERE fstag = wa_SKB1-fstag. "Select para centro
    IF wa_faus1+25(1) = '+'.
      CONCATENATE ' | Centro' 'X' INTO lv_line.
    ENDIF.
    IF wa_faus1+8(1) = '+'.
      CONCATENATE ' | Material' 'X' INTO lv_line.
    ENDIF.
    IF wa_faus1+9(1) = '+'.
      CONCATENATE ' | CCusto' 'X' INTO lv_line.
    ENDIF.
    IF wa_faus1+10(1) = '+'.
      CONCATENATE ' | Ordem' 'X' INTO lv_line.
    ENDIF.
    IF wa_faus1+11(1) = '+'.
      CONCATENATE ' | PEP' 'X' INTO lv_line.
    ENDIF.
    IF wa_faus1+18(1) = '+'.
      CONCATENATE ' | Network' 'X' INTO lv_line.
    ENDIF.
    CONCATENATE ' | Bl_Lan_Plano' wa_ska1-xspeb INTO lv_line.

    SELECT SINGLE bukrs xspeb INTO wa_skb1 FROM skb1 WHERE saknr = wa_ska1-saknr AND bukrs = wa_skb1-bukrs.
    CONCATENATE ' | Empresa' wa_skb1-bukrs
     ' | Bl_Lan_Empresa' wa_skb1-xspeb
     INTO lv_line.
    APPEND lv_line TO lt_conteudo.
  ENDLOOP.
  PERFORM salvar_em_texto.

ENDIF.


IF box_cdc EQ 'X'.
  CLEAR lt_conteudo.
  CONCATENATE p_save '\INFINITFY_CENTRO_CUSTO_' lv_datetime '.txt' INTO lv_filename.
  CONCATENATE  ' Código'
               ' Area_Contabilidade'
               ' Descrição'
               ' Empresa'
               ' Unidade'
               ' Responsável'
               ' Bloqueado'
               ' Valido_Desde'
               ' Valido_Ate'
               INTO lv_line SEPARATED BY ' | '.
  APPEND lv_line TO lt_conteudo.
  DATA lv_ltext TYPE cskt-ltext.
  SELECT * INTO TABLE it_csks FROM csks WHERE ersda BETWEEN p_dt_i AND p_dt_f.
  SELECT * INTO TABLE it_cskt FROM cskt.
  LOOP AT it_csks INTO wa_csks.
    READ TABLE it_cskt INTO wa_cskt WITH KEY kostl = wa_csks-kostl kokrs = wa_csks-kokrs.
    lv_ltext = wa_cskt-ltext.
    CONCATENATE  wa_csks-kostl
                 wa_csks-kokrs
                 lv_ltext
                 wa_csks-bukrs
                 wa_csks-gsber
                 wa_csks-verak
                 wa_csks-bkzkp
                 wa_csks-datab
                 wa_csks-datbi
                 INTO lv_line SEPARATED BY ' | '.
    APPEND lv_line TO lt_conteudo.
  ENDLOOP.
  PERFORM salvar_em_texto.

******************* Centro de contas Modificado
  CLEAR lt_conteudo.
  CLEAR it_cdhdr.
  CONCATENATE p_save '\INFINITFY_CENTRO_CUSTO_MOD_' lv_datetime '.txt' INTO lv_filename.
  DATA lv_objectid1 TYPE c LENGTH 10.
  SELECT * INTO TABLE it_csks FROM csks.
  LOOP AT it_csks INTO wa_csks.
    lv_objectid1 = wa_csks-kostl.
    lv_objectid1 = |{ lv_objectid1 ALPHA = IN }|.
    DATA(lv_objectid) = |{ wa_csks-kokrs }{ lv_objectid1 }|.

    SELECT * INTO TABLE it_cdhdr FROM cdhdr WHERE objectid = lv_objectid AND objectclas = obj_ccusto AND udate BETWEEN p_dt_i AND p_dt_f.
    CONCATENATE  ' Código'
                 ' Area_Contabilidade'
                 ' Descrição'
                 ' Empresa'
                 ' Unidade'
                 ' Responsável'
                 ' Bloqueado'
                 ' Valido_Desde'
                 ' Valido_Ate'
                 INTO lv_line SEPARATED BY ' | '.
    APPEND lv_line TO lt_conteudo.
    LOOP AT it_cdhdr INTO wa_cdhdr.

      READ TABLE it_cskt INTO wa_cskt WITH KEY kostl = wa_csks-kostl kokrs = wa_csks-kokrs.
      lv_ltext = wa_cskt-ltext.
      CONCATENATE  wa_csks-kostl
                   wa_csks-kokrs
                   lv_ltext
                   wa_csks-bukrs
                   wa_csks-gsber
                   wa_csks-verak
                   wa_csks-bkzkp
                   wa_csks-datab
                   wa_csks-datbi
                   INTO lv_line SEPARATED BY ' | '.
      APPEND lv_line TO lt_conteudo.
    ENDLOOP.
  ENDLOOP.
  PERFORM salvar_em_texto.
ENDIF.


IF box_cdl EQ 'X'.
  CLEAR lt_conteudo.
  CONCATENATE p_save '\INFINITFY_CENTRO_LUCRO_' lv_datetime '.txt' INTO lv_filename.
  CONCATENATE 'Código'
              'Descrição'
              'Empresa'
              'Unidade'
              'Responsável'
              'Bloqueado'
              'Valido_Desde'
              'Valido_Ate'
              INTO lv_line SEPARATED BY ' | '.
  APPEND lv_line TO lt_conteudo.

  SELECT * INTO TABLE it_cepc FROM cepc WHERE ersda BETWEEN p_dt_i AND p_dt_f.
  SELECT * INTO TABLE it_cepct FROM cepct.
  SELECT * INTO TABLE it_cepc_bukrs FROM cepc_bukrs.
  SORT it_cepct BY prctr.

  LOOP AT it_cepc INTO wa_cepc.
    READ TABLE it_cepct INTO wa_cepct WITH KEY prctr = wa_cepc-prctr BINARY SEARCH.
    CONCATENATE wa_cepc-prctr
                wa_cepct-ktext
                INTO lv_line SEPARATED BY ' | '.
    LOOP AT it_cepc_bukrs INTO wa_cepc_bukrs WHERE kokrs = wa_cepc-kokrs AND prctr = wa_cepc-prctr.
      CONCATENATE wa_cepc_bukrs-bukrs
                   ' '
        INTO lv_line2 SEPARATED BY ' - '.
    ENDLOOP.
    CONCATENATE
          wa_cepc-verak
          wa_cepc-lock_ind
          wa_cepc-datab
          wa_cepc-datbi
          INTO lv_line3 SEPARATED BY ' | '.
    lv_line = |{ lv_line }{ lv_line2 }{ lv_line3 }|.
    APPEND lv_line TO lt_conteudo.
  ENDLOOP.
  PERFORM salvar_em_texto.

****************** Lucro modificadas
*
*  CLEAR lt_conteudo.
*  CLEAR it_cdhdr.
*  CLEAR it_cepc.
*  CLEAR wa_cdhdr.
*  CLEAR lt_conteudo.
*  CONCATENATE p_save '\INFINITFY_CENTRO_LUCRO_MOD_' lv_datetime '.txt' INTO lv_filename.
*
*  CONCATENATE 'Código'
*              'Descrição'
*              'Empresa'
*              'Unidade'
*              'Responsável'
*              'Bloqueado'
*              'Valido_Desde'
*              'Valido_Ate'
*              INTO lv_line SEPARATED BY ' | '.
*  APPEND lv_line TO lt_conteudo.
*
*  SELECT * INTO TABLE it_cepc FROM cepc WHERE ersda BETWEEN p_dt_i AND p_dt_f.
*  SELECT * INTO TABLE it_cdhdr FROM cdhdr WHERE objectclas = 'OBJ_CLUCRO' AND udate BETWEEN p_dt_i AND p_dt_f.
*  SELECT prctr kokrs INTO TABLE it_cepc FROM cepc.
*  SELECT prctr objnr INTO TABLE it_cmdt_pc FROM cmdt_pc WHERE kokrs = cepc-kokrs.
*
*  LOOP AT it_cepc INTO wa_cepc.
*    lv_objectid1 = wa_cepc-prctr.
*    lv_objectid1 = |{ lv_objectid1 ALPHA = IN }|.
*    lv_objectid = |{ wa_cepc-kokrs }{ lv_objectid1 }|.
*    LOOP AT it_cmdt_pc INTO wa_cmdt_pc.
*      DATA(lv_objectid2) = |{ wa_cepc-kokrs }{ wa_cmdt_pc-objnr }|.
*
*      READ TABLE it_cdhdr INTO wa_cdhdr WITH KEY objectid = lv_objectid.
*      IF sy-subrc = 0.
*        CONCATENATE
*
*
*
*
*          INTO lv_line SEPARATED BY ' | '.
*        APPEND lv_line TO lt_conteudo.
*
*
*      ELSE.
*        READ TABLE it_cdhdr INTO wa_cdhdr WITH KEY objectid = lv_objectid2.
*        IF sy-subrc = 0.
*          CONCATENATE
*
*
*            INTO lv_line SEPARATED BY ' | '.
*          APPEND lv_line TO lt_conteudo.
*
*        ENDIF.
*
*      ENDIF.
*    ENDLOOP.
*   PERFORM salvar_em_texto.
*  ENDLOOP.

ENDIF.

IF box_odi EQ 'X'. " TABELA COAS ESTA ZERADA NO SISTEMA - fiz a logica mas nao consegui testar
  CLEAR lt_conteudo.
  CONCATENATE p_save '\INFINITFY_ORDEM_INVESTIMENTO_' lv_datetime '.txt' INTO lv_filename.

  CONCATENATE 'Código'
              'Descrição'
              'Empresa'
              'Unidade'
              'Responsável'
              'Bloqueado'
              'Status Sistema'
              'Status Usuário'
              'Validação'
              INTO lv_line SEPARATED BY ' | '.
  APPEND lv_line TO lt_conteudo.
  LOOP AT it_parametros_invest INTO wa_parametros_invest.
    SELECT * FROM coas INTO TABLE it_coas WHERE autyp = wa_parametros_invest-valor AND erdat BETWEEN p_dt_i AND p_dt_f. " Tirar duvida do select (erro no tipo do campo AUTYP na it)
    LOOP AT it_coas INTO wa_coas.
      READ TABLE lt_system_status INTO wa_system_status INDEX 1.
      READ TABLE lt_user_status INTO wa_user_status INDEX 1.
      READ TABLE lt_allowed_bus_tract INTO wa_allowed_status INDEX 1.
      PERFORM  BAPI_Bloc. "https://www.se80.co.uk/sap-function-modules/?name=bapi_internalorder_getdetail
      CONCATENATE wa_coas-aufnr
                  wa_coas-ktext
                  wa_coas-bukrs
                  wa_coas-werks
                  wa_coas-user2
                  lv_return
                  wa_system_status-istat
                  wa_user_status-estat " Faltou fazer a validacao Se TJ02T-ISTAT = SYS_BLOK ou TJ30T-ESTAT = USU_BLOK, será retornado “X”.
                  INTO lv_line SEPARATED BY ' | '.
    ENDLOOP.
  ENDLOOP.
  PERFORM salvar_em_texto.

***************** Investimento modificadas
*  CONCATENATE p_save '\INFINITFY_ORDEM_INVESTIMENTO_MOD_' lv_datetime '.txt' INTO lv_filename.





ENDIF.

































*&---------------------------------------------------------------------*
*& Form buscar_cpnj
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*&      --> WA_T001_BUKRS
*&      <-- EMP_CNPJ
*&---------------------------------------------------------------------*
FORM buscar_cpnj  USING    p_wa_t001_bukrs
                  CHANGING p_emp_cnpj.

  CALL FUNCTION 'J_1BREAD_CGC_COMPANY'
    EXPORTING
      bukrs      = p_wa_t001_bukrs
    IMPORTING
      cgc_number = p_emp_cnpj.


ENDFORM.
*&---------------------------------------------------------------------*
*& Form buscar_endereco
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM buscar_endereco .
  LOOP AT it_parametros INTO wa_parametros. " Loop para percorrer todos os parametros da tabela de parametros
    CALL FUNCTION 'J_1B_BRANCH_READ' " https://www.se80.co.uk/sap-function-modules/?name=j_1b_branch_read
      EXPORTING
        branch            = wa_parametros-valor
        company           = wa_t001-bukrs
      IMPORTING
        address           = wa_cidade_est
*       BRANCH_RECORD     =
*       CGC_NUMBER        =
        address_value     = wa_endereco_v
      EXCEPTIONS
        branch_not_found  = 1
        address_not_found = 2
        company_not_found = 3
        OTHERS            = 4.
    IF sy-subrc <> 0.
    ENDIF.
  ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form salvar_em_texto
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM salvar_em_texto .

  CALL FUNCTION 'GUI_DOWNLOAD'
    EXPORTING
      filename = lv_filename
      filetype = 'ASC'
    TABLES
      data_tab = lt_conteudo
    EXCEPTIONS
      OTHERS   = 2.
  IF sy-subrc = 0.
    WRITE: / 'Arquivo salvo com sucesso!'.
  ELSE.
    WRITE: 'Erro ao salvar arquivo'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form BAPI_Bloc
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM BAPI_Bloc .
  CALL FUNCTION 'BAPI_INTERNALORDER_GETDETAIL'
    EXPORTING
      orderid           = wa_coas-aufnr
    IMPORTING
      return            = lv_return
    TABLES
      system_status     = lt_system_status
      user_status       = lt_user_status
      allowed_bus_tract = lt_allowed_bus_tract.


ENDFORM.